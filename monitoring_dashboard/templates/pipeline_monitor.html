<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FLEAD Pipeline Monitor - Live Status</title>
    <style>
        :root {
            --bg: #f3f4f6;
            --bg-elevated: #ffffff;
            --bg-elevated-soft: #f9fafb;
            --border-subtle: #e5e7eb;
            --accent: #2563eb;
            --accent-soft: #dbeafe;
            --accent-strong: #1d4ed8;
            --text-main: #111827;
            --text-muted: #6b7280;
            --badge-healthy: #16a34a;
            --badge-running: #2563eb;
            --badge-stopped: #ef4444;
            --badge-degraded: #f97316;
            --badge-unknown: #f59e0b;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.14);
            --card-radius: 18px;
        }

        body.dark-mode {
            --bg: #020617;
            --bg-elevated: #0b1220;
            --bg-elevated-soft: #020617;
            --border-subtle: #1f2937;
            --accent: #60a5fa;
            --accent-soft: #0b1120;
            --accent-strong: #3b82f6;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                sans-serif;
            background: radial-gradient(circle at top left, #e5edff 0, var(--bg) 45%);
            color: var(--text-main);
            padding: 24px;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background: radial-gradient(circle at top left, #0b1120 0, #020617 40%);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
        }

        .title-block h1 {
            font-size: 2.4rem;
            letter-spacing: 0.03em;
            margin-bottom: 4px;
        }

        .subtitle {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .top-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .pill code {
            font-size: 0.85em;
        }

        select.refresh-select {
            border: none;
            background: transparent;
            font-size: 0.85rem;
            color: inherit;
            outline: none;
            cursor: pointer;
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.18);
            border: 1px solid rgba(148, 163, 184, 0.35);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .toggle-knob {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: #f9fafb;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.5);
            transform: translateX(0);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        body.dark-mode .toggle-knob {
            transform: translateX(18px);
            background: #0f172a;
        }

        .toggle-label {
            padding: 0 6px;
        }

        .button-ghost {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.02);
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .button-ghost:hover {
            border-color: var(--accent);
            color: var(--accent-strong);
        }

        /* Pipeline flow */

        .pipeline-flow-wrapper {
            background: var(--bg-elevated);
            border-radius: 26px;
            padding: 20px 24px;
            margin-bottom: 18px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .pipeline-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .flow-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .flow-icon {
            width: 76px;
            height: 76px;
            margin: 0 auto 8px;
            border-radius: 999px;
            background: var(--bg-elevated-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.15);
        }

        .flow-icon img {
            width: 46px;
            height: 46px;
        }

        /* make upstream logos visible in dark mode */
        body.dark-mode .flow-icon img {
            filter: brightness(0) invert(1);
        }

        .flow-step.active .flow-icon {
            box-shadow: 0 0 32px rgba(37, 99, 235, 0.7);
            outline: 2px solid var(--accent);
        }

        .flow-label-main {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .flow-label-sub {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .flow-arrow {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.4rem;
            color: rgba(148, 163, 184, 0.7);
        }

        .flow-step:last-child .flow-arrow {
            display: none;
        }

        /* Layout below flow */

        .main-grid {
            display: grid;
            grid-template-columns: 2.1fr 2.1fr 3.2fr;
            gap: 16px;
            align-items: flex-start;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }

        .stat-card,
        .overview-card,
        .activity-feed {
            background: var(--bg-elevated);
            border-radius: var(--card-radius);
            padding: 18px 18px 16px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 14px 30px rgba(15, 23, 42, 0.14);
            transition: transform 0.15s ease, box-shadow 0.15s ease,
                border-color 0.15s ease, background 0.15s ease;
        }

        .stat-card:hover,
        .activity-feed:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.2);
            border-color: rgba(37, 99, 235, 0.45);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #f9fafb;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .status-healthy { background: var(--badge-healthy); }
        .status-running { background: var(--badge-running); }
        .status-stopped { background: var(--badge-stopped); }
        .status-degraded { background: var(--badge-degraded); }
        .status-unknown { background: var(--badge-unknown); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--accent-strong);
        }

        .stat-detail {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 2px 0;
        }

        .stat-detail strong {
            color: var(--text-main);
        }

        .metric-bar {
            height: 6px;
            background: rgba(148, 163, 184, 0.25);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #22c55e);
            width: 0%;
            transition: width 0.5s ease;
        }

        .sparkline {
            width: 100%;
            height: 36px;
            margin-top: 8px;
            border-radius: 10px;
            background: radial-gradient(circle at top, rgba(148, 163, 184, 0.12), transparent 50%);
        }

        /* Overview + activity */

        .overview-card {
            margin-bottom: 14px;
        }

        .overview-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .overview-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: 1.2fr 1.2fr 1.4fr;
            gap: 8px;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .overview-grid strong {
            color: var(--text-main);
        }

        .activity-feed {
            max-height: 520px;
            overflow-y: auto;
        }

        .activity-feed h2 {
            font-size: 0.92rem;
            margin-bottom: 12px;
        }

        .activity-item {
            background: var(--bg-elevated-soft);
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent);
            font-size: 0.8rem;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .activity-device {
            font-weight: 600;
            color: var(--accent-strong);
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .activity-details {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .detail-item {
            display: flex;
            gap: 4px;
            font-size: 0.78rem;
        }

        .detail-label {
            color: var(--text-muted);
        }

        .last-updated {
            margin-top: 10px;
            font-size: 0.78rem;
            color: var(--text-muted);
            text-align: right;
        }

        /* Clickable cards */

        .clickable {
            cursor: pointer;
        }

        .clickable:active {
            transform: translateY(0);
            box-shadow: 0 8px 25px rgba(15, 23, 42, 0.25);
        }

        /* JSON drawer */

        .json-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 420px;
            max-width: 80%;
            height: 100%;
            background: var(--bg-elevated);
            box-shadow: -18px 0 40px rgba(15, 23, 42, 0.65);
            border-left: 1px solid var(--border-subtle);
            transform: translateX(100%);
            transition: transform 0.25s ease;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }

        .json-panel.open {
            transform: translateX(0);
        }

        .json-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .json-panel-title span {
            display: block;
        }

        .json-panel-title small {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .json-close {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .json-content {
            flex: 1;
            padding: 10px 16px 16px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco,
                Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.78rem;
            line-height: 1.4;
            white-space: pre;
        }

        pre {
            margin: 0;
        }

        /* Loading */

        .loading {
            text-align: center;
            padding: 24px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .spinner {
            border: 3px solid rgba(148, 163, 184, 0.3);
            border-top: 3px solid var(--accent);
            border-radius: 999px;
            width: 24px;
            height: 24px;
            margin: 0 auto 10px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1.7fr 1.7fr;
            }
        }

        @media (max-width: 900px) {
            body { padding: 16px; }
            .main-grid {
                grid-template-columns: 1fr;
            }
            header {
                flex-direction: column;
                gap: 10px;
            }
            .pipeline-flow-wrapper {
                margin-bottom: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="title-block">
                <h1>FLEAD Pipeline Monitor</h1>
                <div class="subtitle">
                    Real-time Federated Learning &amp; Edge Analytics Status
                </div>
            </div>
            <div class="top-controls">
                <div class="pill">
                    <span>Refresh:</span>
                    <select id="refresh-select" class="refresh-select">
                        <option value="2000">2s</option>
                        <option value="5000">5s</option>
                        <option value="10000">10s</option>
                        <option value="30000">30s</option>
                    </select>
                </div>
                <div class="pill">
                    <span>Backend:</span>
                    <code>/api/status</code>
                </div>
                <button id="json-main-toggle" class="button-ghost">
                    Raw JSON
                </button>
                <button id="theme-toggle" class="toggle" type="button" aria-pressed="false">
                    <span class="toggle-label">Light</span>
                    <div class="toggle-knob"></div>
                </button>
            </div>
        </header>

        <!-- Pipeline flow -->
        <div class="pipeline-flow-wrapper">
            <div class="pipeline-flow">
                <div class="flow-step" id="step-kafka">
                    <div class="flow-icon">
                        <img
                            src="https://cdn.worldvectorlogo.com/logos/kafka.svg"
                            alt="Kafka"
                            onerror="this.style.display='none';this.parentElement.textContent='KFK';"
                        />
                    </div>
                    <div class="flow-label-main">Kafka</div>
                    <div class="flow-label-sub">Data Streaming</div>
                    <div class="flow-arrow">→</div>
                </div>

                <div class="flow-step" id="step-flink">
                    <div class="flow-icon">
                        <img
                            src="https://flink.apache.org/img/logo/png/1000/flink_squirrel_1000.png"
                            alt="Flink"
                            onerror="this.style.display='none';this.parentElement.textContent='FLK';"
                        />
                    </div>
                    <div class="flow-label-main">Flink</div>
                    <div class="flow-label-sub">Local ML Training</div>
                    <div class="flow-arrow">→</div>
                </div>

                <div class="flow-step" id="step-aggregation">
                    <div class="flow-icon" style="font-weight:600;font-size:1.3rem;background:rgba(37,99,235,0.12);color:var(--accent-strong);">
                        AGG
                    </div>
                    <div class="flow-label-main">Aggregation</div>
                    <div class="flow-label-sub">Global Model</div>
                    <div class="flow-arrow">→</div>
                </div>

                <div class="flow-step" id="step-database">
                    <div class="flow-icon">
                        <img
                            src="https://avatars.githubusercontent.com/u/5430574?s=200&v=4"
                            alt="TimescaleDB"
                            onerror="this.style.display='none';this.parentElement.textContent='DB';"
                        />
                    </div>
                    <div class="flow-label-main">TimescaleDB</div>
                    <div class="flow-label-sub">Time-series Storage</div>
                    <div class="flow-arrow">→</div>
                </div>

                <div class="flow-step" id="step-grafana">
                    <div class="flow-icon">
                        <img
                            src="https://cdn.worldvectorlogo.com/logos/grafana.svg"
                            alt="Grafana"
                            onerror="this.style.display='none';this.parentElement.textContent='VIZ';"
                        />
                    </div>
                    <div class="flow-label-main">Grafana</div>
                    <div class="flow-label-sub">Dashboards &amp; UIs</div>
                </div>
            </div>
        </div>

        <!-- Main content grid -->
        <div class="main-grid">
            <!-- Left column: Kafka + Global -->
            <div class="stats-grid">
                <div class="stat-card clickable" id="card-kafka">
                    <div class="stat-header">
                        <div class="stat-title">Kafka Messages</div>
                        <div class="status-badge status-unknown" id="kafka-status">
                            Unknown
                        </div>
                    </div>
                    <div class="stat-value" id="kafka-total">-</div>
                    <div class="stat-detail">
                        IoT Stream: <strong id="kafka-iiot">-</strong>
                    </div>
                    <div class="stat-detail">
                        Local Model Updates: <strong id="kafka-models">-</strong>
                    </div>
                    <div class="stat-detail">
                        Global Updates: <strong id="kafka-global">-</strong>
                    </div>
                    <canvas id="spark-kafka" class="sparkline"></canvas>
                </div>

                <div class="stat-card clickable" id="card-global">
                    <div class="stat-header">
                        <div class="stat-title">Global Models</div>
                        <div class="status-badge status-running" id="global-status">
                            Active
                        </div>
                    </div>
                    <div class="stat-value" id="federated-total">-</div>
                    <div class="stat-detail">
                        Last minute: <strong id="federated-minute">-</strong>
                    </div>
                    <div class="stat-detail">
                        Last 5 min: <strong id="federated-5min">-</strong>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" id="federated-activity"></div>
                    </div>
                    <canvas id="spark-global" class="sparkline"></canvas>
                </div>
            </div>

            <!-- Middle column: Flink + Local + Health -->
            <div class="stats-grid">
                <div class="stat-card clickable" id="card-flink">
                    <div class="stat-header">
                        <div class="stat-title">Flink Jobs</div>
                        <div class="status-badge status-unknown" id="flink-status">
                            Loading
                        </div>
                    </div>
                    <div class="stat-value" id="flink-jobs">-</div>
                    <div class="stat-detail" id="flink-details">
                        Checking jobs...
                    </div>
                </div>

                <div class="stat-card clickable" id="card-local">
                    <div class="stat-header">
                        <div class="stat-title">Local Models</div>
                        <div class="status-badge status-running" id="db-status">
                            Running
                        </div>
                    </div>
                    <div class="stat-value" id="local-total">-</div>
                    <div class="stat-detail">
                        Last minute: <strong id="local-minute">-</strong>
                    </div>
                    <div class="stat-detail">
                        Last 5 min: <strong id="local-5min">-</strong>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" id="local-activity"></div>
                    </div>
                    <canvas id="spark-local" class="sparkline"></canvas>
                </div>

                <div class="stat-card clickable" id="card-health">
                    <div class="stat-header">
                        <div class="stat-title">Pipeline Health</div>
                        <div class="status-badge status-unknown" id="health-status">
                            Unknown
                        </div>
                    </div>
                    <div class="stat-value" id="health-text">-</div>
                    <div class="stat-detail">
                        Docker Services: <strong id="docker-count">-</strong>
                    </div>
                    <div class="stat-detail">
                        Data Flow: <strong id="flow-status">-</strong>
                    </div>
                </div>
            </div>

            <!-- Right column: overview + recent models -->
            <div>
                <div class="overview-card">
                    <div class="overview-title">Pipeline Overview</div>
                    <div class="overview-text">
                        Click any service or stat card for focused JSON or to inspect
                        topics, jobs, and model activity in more detail.
                    </div>
                    <div class="overview-grid">
                        <div>
                            <strong>Kafka Topics:</strong><br />
                            edge-iiot-stream, local/global updates
                        </div>
                        <div>
                            <strong>Training Flow:</strong><br />
                            Kafka → Flink → Aggregator → TimescaleDB
                        </div>
                        <div>
                            <strong>Monitoring:</strong><br />
                            Monitoring Dashboard + Grafana
                        </div>
                    </div>
                </div>

                <div class="activity-feed">
                    <h2>Recent Model Training Activity</h2>
                    <div id="activity-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading recent activity...
                        </div>
                    </div>
                </div>

                <div class="last-updated">
                    Last updated: <span id="last-update">Never</span>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON drawer -->
    <div class="json-panel" id="json-panel">
        <div class="json-panel-header">
            <div class="json-panel-title">
                <span id="json-title">Raw /api/status</span>
                <small id="json-subtitle">Full payload</small>
            </div>
            <button class="json-close" id="json-close" aria-label="Close JSON">&times;</button>
        </div>
        <div class="json-content">
            <pre id="json-content">{}</pre>
        </div>
    </div>

    <script>
        let isUpdating = false;
        let errorCount = 0;
        const MAX_ERRORS = 3;
        let refreshMs = 2000;
        let refreshTimer = null;
        let lastStatus = null;

        const historyData = {
            kafka: [],
            local: [],
            global: [],
        };
        const MAX_POINTS = 40;

        // THEME
        const themeToggle = document.getElementById("theme-toggle");
        const themeLabel = themeToggle.querySelector(".toggle-label");

        function applyThemeFromStorage() {
            const stored = localStorage.getItem("flead-theme");
            const prefersDark = window.matchMedia &&
                window.matchMedia("(prefers-color-scheme: dark)").matches;

            const useDark = stored === "dark" || (!stored && prefersDark);
            document.body.classList.toggle("dark-mode", useDark);
            themeLabel.textContent = useDark ? "Dark" : "Light";
        }

        applyThemeFromStorage();

        themeToggle.addEventListener("click", () => {
            const isDark = !document.body.classList.contains("dark-mode");
            document.body.classList.toggle("dark-mode", isDark);
            localStorage.setItem("flead-theme", isDark ? "dark" : "light");
            themeLabel.textContent = isDark ? "Dark" : "Light";
        });

        // JSON drawer helpers
        const jsonPanel = document.getElementById("json-panel");
        const jsonTitle = document.getElementById("json-title");
        const jsonSubtitle = document.getElementById("json-subtitle");
        const jsonContent = document.getElementById("json-content");

        function openJsonDrawer(payload, title, subtitle) {
            if (!payload && !lastStatus) return;
            jsonTitle.textContent = title || "Raw /api/status";
            jsonSubtitle.textContent =
                subtitle || "Full payload";
            jsonContent.textContent = JSON.stringify(payload || lastStatus, null, 2);
            jsonPanel.classList.add("open");
        }

        function closeJsonDrawer() {
            jsonPanel.classList.remove("open");
        }

        document.getElementById("json-close").addEventListener("click", closeJsonDrawer);
        document.getElementById("json-main-toggle").addEventListener("click", () =>
            openJsonDrawer(lastStatus, "Raw /api/status", "Full payload")
        );

        // Refresh select
        document.getElementById("refresh-select").addEventListener("change", (e) => {
            refreshMs = parseInt(e.target.value, 10);
            scheduleRefresh();
        });

        function scheduleRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(updateDashboard, refreshMs);
        }

        // Status badges
        function updateStatus(elementId, status) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = "status-badge";
            const s = (status || "").toString().toLowerCase();

            if (s === "healthy") {
                el.classList.add("status-healthy");
                el.textContent = "Healthy";
            } else if (s === "running" || s === "active") {
                el.classList.add("status-running");
                el.textContent = "Running";
            } else if (s === "stopped" || s === "idle") {
                el.classList.add("status-stopped");
                el.textContent = "Stopped";
            } else if (s === "degraded") {
                el.classList.add("status-degraded");
                el.textContent = "Degraded";
            } else {
                el.classList.add("status-unknown");
                el.textContent = "Unknown";
            }
        }

        function updateFlowStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (!step) return;
            const s = (status || "").toString().toLowerCase();
            if (["healthy", "running", "active"].includes(s)) {
                step.classList.add("active");
            } else {
                step.classList.remove("active");
            }
        }

        // Sparklines
        function drawSparkline(canvasId, values) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || values.length < 2) return;
            const ctx = canvas.getContext("2d");
            const width = canvas.width = canvas.clientWidth * 2;
            const height = canvas.height = canvas.clientHeight * 2;

            ctx.clearRect(0, 0, width, height);

            const maxVal = Math.max(...values);
            const minVal = Math.min(...values);
            const range = maxVal - minVal || 1;

            const stepX = width / (values.length - 1);

            const dark = document.body.classList.contains("dark-mode");
            ctx.strokeStyle = dark ? "#60a5fa" : "#2563eb";
            ctx.lineWidth = 2;
            ctx.lineJoin = "round";
            ctx.lineCap = "round";

            ctx.beginPath();
            values.forEach((v, idx) => {
                const x = idx * stepX;
                const norm = (v - minVal) / range;
                const y = height - norm * (height - 8) - 4;
                if (idx === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        // Main update loop
        async function updateDashboard() {
            if (isUpdating) return;
            isUpdating = true;

            try {
                const response = await fetch("/api/status");
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                lastStatus = data;
                errorCount = 0;

                // Timestamp
                document.getElementById("last-update").textContent =
                    new Date(data.timestamp).toLocaleTimeString();

                // Kafka stats
                const kafkaStats = data.kafka || {};
                const iiot = kafkaStats["edge-iiot-stream"] || 0;
                const localUpdates = kafkaStats["local-model-updates"] || 0;
                const globalUpdates = kafkaStats["global-model-updates"] || 0;
                const kafkaTotal = iiot + localUpdates + globalUpdates;

                document.getElementById("kafka-total").textContent =
                    kafkaTotal.toLocaleString();
                document.getElementById("kafka-iiot").textContent =
                    iiot.toLocaleString();
                document.getElementById("kafka-models").textContent =
                    localUpdates.toLocaleString();
                document.getElementById("kafka-global").textContent =
                    globalUpdates.toLocaleString();

                // Map our kafka_status to badge types
                const kafkaStatus =
                    (data.kafka_status || (kafkaTotal > 0 ? "running" : "stopped"));
                updateStatus(
                    "kafka-status",
                    kafkaStatus === "active" ? "running" : kafkaStatus
                );
                updateFlowStep(
                    "step-kafka",
                    kafkaStatus === "active" ? "running" : kafkaStatus
                );

                // Flink jobs
                const flinkJobs = data.flink || [];
                document.getElementById("flink-jobs").textContent =
                    flinkJobs.length;
                if (flinkJobs.length > 0) {
                    const jobNames = flinkJobs
                        .map((j) => `${j.name} (${j.status})`)
                        .join(", ");
                    document.getElementById("flink-details").textContent =
                        jobNames;
                    updateStatus(
                        "flink-status",
                        (flinkJobs[0].status || "").toLowerCase()
                    );
                    updateFlowStep("step-flink", "running");
                } else {
                    document.getElementById("flink-details").textContent =
                        "No jobs running";
                    updateStatus("flink-status", "stopped");
                    updateFlowStep("step-flink", "stopped");
                }

                // Database stats
                const dbStats = data.database || {};
                const local = dbStats.local_models || {
                    total: 0,
                    last_minute: 0,
                    last_5min: 0,
                };
                const federated = dbStats.federated_models || {
                    total: 0,
                    last_minute: 0,
                    last_5min: 0,
                };

                document.getElementById("local-total").textContent =
                    local.total.toLocaleString();
                document.getElementById("local-minute").textContent =
                    local.last_minute;
                document.getElementById("local-5min").textContent =
                    local.last_5min;

                const localActivity =
                    Math.min((local.last_minute / 50) * 100, 100);
                document.getElementById("local-activity").style.width =
                    localActivity + "%";

                updateStatus("db-status", data.docker_services?.timescaledb);
                updateFlowStep(
                    "step-database",
                    data.docker_services?.timescaledb
                );

                document.getElementById("federated-total").textContent =
                    federated.total.toLocaleString();
                document.getElementById("federated-minute").textContent =
                    federated.last_minute;
                document.getElementById("federated-5min").textContent =
                    federated.last_5min;

                const federatedActivity =
                    Math.min((federated.last_minute / 10) * 100, 100);
                document.getElementById("federated-activity").style.width =
                    federatedActivity + "%";

                updateFlowStep(
                    "step-aggregation",
                    federated.last_5min > 0 ? "running" : "stopped"
                );

                // Python processes
                const pythonProcs = data.python_processes || [];
                document.getElementById("python-count") &&
                    (document.getElementById("python-count").textContent =
                        pythonProcs.length);
                if (pythonProcs.length > 0) {
                    const procList = pythonProcs
                        .map((p) => `[OK] ${p.name} (PID: ${p.pid})`)
                        .join("<br>");
                    const listEl = document.getElementById("python-list");
                    if (listEl) listEl.innerHTML = procList;
                }

                // Overall health
                const dockerStatuses = Object.values(data.docker_services || {});
                const dockerHealthy = dockerStatuses.filter((s) =>
                    ["healthy", "running", "active"].includes(
                        (s || "").toString().toLowerCase()
                    )
                ).length;

                document.getElementById("health-text").textContent =
                    (data.pipeline_health || "unknown").toUpperCase();
                document.getElementById("docker-count").textContent =
                    `${dockerHealthy}/${dockerStatuses.length} healthy`;
                document.getElementById("flow-status").textContent =
                    kafkaTotal > 0 ? "Active" : "Idle";
                updateStatus("health-status", data.pipeline_health);
                updateFlowStep(
                    "step-grafana",
                    data.docker_services?.grafana
                );

                // Activity feed
                const activityRoot = document.getElementById("activity-list");
                if (data.recent_models && data.recent_models.length > 0) {
                    const html = data.recent_models
                        .map(
                            (model) => `
                        <div class="activity-item">
                            <div class="activity-header">
                                <div class="activity-device">${model.device_id}</div>
                                <div class="activity-time">${formatTime(
                                    model.timestamp
                                )}</div>
                            </div>
                            <div class="activity-details">
                                <div class="detail-item">
                                    <span class="detail-label">Version:</span>
                                    <span>${model.model_version}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Accuracy:</span>
                                    <span>${(model.accuracy * 100).toFixed(
                                        1
                                    )}%</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Samples:</span>
                                    <span>${model.samples}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Global:</span>
                                    <span>v${model.global_version}</span>
                                </div>
                            </div>
                        </div>`
                        )
                        .join("");
                    activityRoot.innerHTML = html;
                } else {
                    activityRoot.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            Waiting for local model updates...
                        </div>`;
                }

                // Update sparkline histories
                pushHistory(historyData.kafka, kafkaTotal);
                pushHistory(historyData.local, local.total);
                pushHistory(historyData.global, federated.total);

                drawSparkline("spark-kafka", historyData.kafka);
                drawSparkline("spark-local", historyData.local);
                drawSparkline("spark-global", historyData.global);
            } catch (err) {
                console.error("Error updating dashboard:", err);
                errorCount++;

                if (errorCount >= MAX_ERRORS) {
                    document.getElementById("health-text").textContent =
                        "ERROR";
                    document.getElementById("health-status").className =
                        "status-badge status-stopped";
                    document.getElementById("health-status").textContent =
                        "Connection Lost";
                    document.getElementById("activity-list").innerHTML = `
                        <div class="activity-item" style="background: rgba(239,68,68,0.08); border-left-color:#ef4444;">
                            <div style="font-size:0.9rem; margin-bottom:4px;"><strong>Connection error</strong></div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">
                                Cannot reach <code>/api/status</code>. Error: ${err.message}
                            </div>
                        </div>`;
                }
            } finally {
                isUpdating = false;
            }
        }

        function pushHistory(arr, value) {
            arr.push(value);
            if (arr.length > MAX_POINTS) arr.shift();
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleString();
        }

        // Card click → JSON drawer
        function wireCardJson(cardId, extractor, title) {
            const el = document.getElementById(cardId);
            if (!el) return;
            el.addEventListener("click", () => {
                if (!lastStatus) return;
                const payload = extractor ? extractor(lastStatus) : lastStatus;
                openJsonDrawer(payload, title, "Subset of /api/status");
            });
        }

        wireCardJson("card-kafka", (s) => ({ kafka: s.kafka, kafka_status: s.kafka_status }), "Kafka Topics");
        wireCardJson("card-flink", (s) => ({ flink: s.flink }), "Flink Jobs");
        wireCardJson("card-local", (s) => ({ local_models: s.database?.local_models }), "Local Models Table");
        wireCardJson("card-global", (s) => ({ federated_models: s.database?.federated_models }), "Global Models Table");
        wireCardJson("card-health", (s) => ({ docker_services: s.docker_services, pipeline_health: s.pipeline_health }), "Docker & Health");

        // First update & schedule
        updateDashboard();
        scheduleRefresh();
    </script>
</body>
</html>
