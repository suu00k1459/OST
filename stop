#!/usr/bin/env bash
# ============================================================================
# FLEAD Platform Shutdown Script (Linux/macOS/WSL)
# Stops all Docker services and cleans up containers
# Usage: ./stop
# ============================================================================
set -e

# Go to repo root (directory of this script)
cd "$(dirname "$0")"

echo
echo "==================================================="
echo "FEDERATED LEARNING PLATFORM - SHUTDOWN (POSIX)"
echo "==================================================="
echo

echo "Stopping all services..."
echo

# Force kill all running containers
echo "Killing running containers..."
docker kill $(docker ps -q) 2>/dev/null || true
echo "Done."

# Force remove all containers
echo "Removing all containers..."
docker rm -f $(docker ps -aq) 2>/dev/null || true
echo "Done."

# Docker compose cleanup
echo "Running docker compose cleanup..."
if docker compose version >/dev/null 2>&1; then
  docker compose down -v --remove-orphans 2>/dev/null || true
elif command -v docker-compose >/dev/null 2>&1; then
  docker-compose down -v --remove-orphans 2>/dev/null || true
fi
echo "Done."

# Prune volumes
echo "Pruning unused volumes..."
docker volume prune -f 2>/dev/null || true
echo "Done."
echo

echo "==================================================="
echo "SHUTDOWN COMPLETE (POSIX)"
echo "==================================================="
echo "To start again: ./start"
echo
